#!/usr/bin/env ruby
# WANT_JSON

require 'json'
require 'shellwords'
require 'pp'

require 'nrser'
require 'state_mate'

using NRSER

def main
  input = nil
  args = nil
  changed = false

  begin
    input = File.read ARGV[0]
    args = JSON.load input
    
    raise "arg fail" if args['fail']
    
    # filter out keys that start with '_ansible', which are ansible-added
    # values.
    # 
    # example:
    # 
    #     {"_ansible_version"=>"2.1.0.0",
    #      "_ansible_selinux_special_fs"=>["fuse", "nfs", "vboxsf", "ramfs"],
    #      "_ansible_no_log"=>false,
    #      "_ansible_verbosity"=>0,
    #      "_ansible_syslog_facility"=>"LOG_USER",
    #      "_ansible_diff"=>false,
    #      "_ansible_debug"=>false,
    #      "_ansible_check_mode"=>false}
    #
    spec = args.reject {|k, v| k.start_with? '_ansible'}
    
    changes = StateMate.execute spec

    print JSON.dump({
      'changed' => !changes.empty?,
      'changes' => changes,
    })
  rescue Exception => e
    print JSON.dump({
      'failed' => true,
      'msg' => e.format,
      # 'input' => input,
      'args' => args,
      # 'ARGV' => ARGV,
      # 'ruby' => RUBY_VERSION,
    })
  end
end

main if __FILE__ == $0
